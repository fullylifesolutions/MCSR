<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="M.C.S. - Monitoraggio Clima di Sicurezza. App per la compilazione mensile del questionario aziendale.">
    <meta name="theme-color" content="#00FFCA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="M.C.S.">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <title>M.C.S. - Monitoraggio Clima di Sicurezza</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #0A4D68;
            --primary-light: #088395;
            --secondary: #05BFDB;
            --accent: #00FFCA;
            --dark: #1A1A2E;
            --gray: #16213E;
            --light-gray: #E8F4F8;
            --white: #FFFFFF;
            --success: #00D9A5;
            --warning: #FFB800;
            --danger: #FF5757;
            --critical: #C70039;
        }
        
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--gray) 100%);
            color: var(--white);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px 40px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .btn-help {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            background: var(--secondary);
            color: var(--dark);
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'IBM Plex Sans', sans-serif;
            z-index: 10;
        }

        .btn-help:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 202, 0.3);
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            margin-top: 20px;
            background: linear-gradient(135deg, var(--accent), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding: 0 50px;
        }
        
        .header p {
            color: var(--light-gray);
            font-size: 1rem;
            padding: 0 50px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 50px 15px 30px 15px;
            }

            .btn-help {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 0.85rem;
            }

            .header h1 {
                font-size: 1.5rem;
                margin-top: 0;
                padding: 0 10px;
            }

            .header p {
                font-size: 0.9rem;
                padding: 0 10px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .header p {
                font-size: 0.85rem;
            }

            .btn-help {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
        }
        
        .meta-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .meta-field {
            margin-bottom: 10px;
        }
        
        .meta-info input, .meta-info select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--white);
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 1rem;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        .meta-info select {
            cursor: pointer;
        }

        .meta-info select option {
            background: var(--dark);
            color: var(--white);
        }
        
        .meta-info input:focus, .meta-info select:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .meta-info label {
            display: block;
            margin-bottom: 5px;
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .meta-info label.required::after {
            content: ' *';
            color: var(--danger);
        }
        
        .dimension-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 4px solid var(--secondary);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .dimension-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 202, 0.1);
        }
        
        .dimension-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dimension-number {
            background: var(--primary-light);
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
        }
        
        .question {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .question:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .question-text {
            margin-bottom: 15px;
            font-size: 1rem;
            line-height: 1.6;
            color: var(--light-gray);
        }
        
        .likert-scale {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }
        
        .likert-option {
            flex: 1;
            position: relative;
        }
        
        .likert-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .likert-label {
            display: block;
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .likert-option input[type="radio"]:checked + .likert-label {
            background: var(--secondary);
            border-color: var(--accent);
            color: var(--dark);
            font-weight: 700;
            transform: scale(1.05);
        }
        
        .likert-label:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--secondary);
        }
        
        .score-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent);
        }
        
        .results-section {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            padding: 40px;
            border-radius: 15px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .results-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .score-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--secondary);
        }
        
        .score-card h4 {
            color: var(--accent);
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .score-card .score {
            font-size: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .score-card .level {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            font-weight: 600;
        }
        
        .level.critico { background: var(--critical); color: white; }
        .level.scarso { background: var(--danger); color: white; }
        .level.sufficiente { background: var(--warning); color: var(--dark); }
        .level.buono { background: #FFE135; color: var(--dark); }
        .level.molto-buono { background: #92D050; color: var(--dark); }
        .level.eccellente { background: var(--success); color: white; }
        
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'IBM Plex Sans', sans-serif;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: var(--dark);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 202, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 2px solid var(--secondary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-backup {
            background: var(--warning);
            color: var(--dark);
        }

        .btn-backup:hover {
            background: #FFC520;
            transform: translateY(-2px);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--accent));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .history-section {
            margin-top: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .history-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .history-item:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: translateX(5px);
            border-left: 3px solid var(--accent);
            box-shadow: 0 5px 15px rgba(0, 255, 202, 0.2);
        }

        .history-item::after {
            content: 'üëÅÔ∏è';
            font-size: 1.2rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .history-item:hover::after {
            opacity: 1;
        }
        
        .history-date {
            font-family: 'JetBrains Mono', monospace;
            color: var(--secondary);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--dark), var(--gray));
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            border: 2px solid var(--accent);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 {
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .modal-content p {
            color: var(--light-gray);
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }

        .help-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 3px solid var(--accent);
        }

        .help-section h4 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .help-section p, .help-section ul {
            color: var(--light-gray);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .help-section ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .help-section li {
            margin-bottom: 8px;
        }

        .help-section code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 3px;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .platform-icon {
            font-size: 1.3rem;
            margin-right: 8px;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .likert-scale { flex-direction: column; }
            .scores-grid { grid-template-columns: 1fr; }
            .meta-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="btn-help" onclick="showHelp()" title="Istruzioni e Aiuto">‚ùì Aiuto</button>
            <h1>üìä Monitoraggio del Clima di Sicurezza</h1>
            <p>Questionario Mensile - Collaboratore</p>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="meta-info">
            <h3 style="color: var(--accent); margin-bottom: 20px;">üìã Informazioni Generali</h3>
            <div class="meta-grid">
                <div class="meta-field">
                    <label for="nomeAzienda" class="required">Nome Azienda</label>
                    <input type="text" id="nomeAzienda" placeholder="es. Acme S.p.A." required>
                </div>
                
                <div class="meta-field">
                    <label for="nomePersona" class="required">Nome e Cognome</label>
                    <input type="text" id="nomePersona" placeholder="es. Mario Rossi" required>
                </div>

                <div class="meta-field">
                    <label for="reparto">Reparto/Divisione</label>
                    <input type="text" id="reparto" placeholder="es. Produzione, Magazzino...">
                </div>
                
                <div class="meta-field">
                    <label for="anzianita">Anni di Anzianit√†</label>
                    <input type="number" id="anzianita" min="0" placeholder="es. 5">
                </div>

                <div class="meta-field">
                    <label for="meseMonitoraggio" class="required">Mese di Monitoraggio</label>
                    <select id="meseMonitoraggio" required>
                        <option value="">Seleziona mese...</option>
                        <option value="01">Gennaio</option>
                        <option value="02">Febbraio</option>
                        <option value="03">Marzo</option>
                        <option value="04">Aprile</option>
                        <option value="05">Maggio</option>
                        <option value="06">Giugno</option>
                        <option value="07">Luglio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Settembre</option>
                        <option value="10">Ottobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Dicembre</option>
                    </select>
                </div>

                <div class="meta-field">
                    <label for="annoMonitoraggio" class="required">Anno</label>
                    <select id="annoMonitoraggio" required>
                        <option value="">Seleziona anno...</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="questionnaire"></div>

        <div class="meta-info" style="margin-top: 30px;">
            <h3 style="color: var(--accent); margin-bottom: 15px;">üìù Note Aggiuntive (Opzionale)</h3>
            <textarea id="noteAggiuntive" 
                      placeholder="Inserisci qui eventuali note, commenti o osservazioni sul clima di sicurezza..."
                      style="width: 100%; min-height: 120px; padding: 15px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: var(--white); font-family: 'IBM Plex Sans', sans-serif; font-size: 1rem; resize: vertical;"></textarea>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" onclick="calculateResults()">üìà Calcola Risultati</button>
            <button class="btn btn-backup" onclick="createBackup()">üíæ Backup Dati</button>
            <button class="btn btn-secondary" id="exitViewButton" onclick="exitViewMode()" style="display: none;">üö™ Esci da Visualizzazione</button>
        </div>

        <div class="results-section" id="resultsSection">
            <h2 style="text-align: center; margin-bottom: 30px; color: var(--accent);">I Tuoi Risultati</h2>
            
            <div class="chart-container">
                <h3 style="color: var(--dark); text-align: center; margin-bottom: 5px; font-size: 1.5rem;">Monitoraggio del Clima di Sicurezza</h3>
                <p id="chartPeriod" style="color: var(--gray); text-align: center; margin-bottom: 20px; font-size: 1.1rem; font-weight: 600;"></p>
                <canvas id="radarChart"></canvas>
            </div>

            <div class="scores-grid" id="scoresGrid"></div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="exportJSON()">üíæ Esporta JSON</button>
                <button class="btn btn-secondary" onclick="newMonitoring()">üîÑ Nuovo Monitoraggio</button>
            </div>
        </div>

        <div class="history-section" id="historySection" style="display: none;">
            <h3 style="color: var(--accent); margin-bottom: 10px;">üìÖ Storico Monitoraggi</h3>
            <p style="color: var(--light-gray); font-size: 0.9rem; margin-bottom: 20px;">
                üí° Clicca su un questionario per visualizzarlo in modalit√† sola lettura
                <br>
                <span style="font-size: 0.85rem; color: var(--secondary);">Per uscire dalla visualizzazione e creare un nuovo monitoraggio, usa il pulsante "Esci da Visualizzazione"</span>
            </p>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- Modal Backup Reminder -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <h3>üíæ Promemoria Backup</h3>
            <p>Ricorda di effettuare un backup dei tuoi dati regolarmente!</p>
            <p>Hai salvato le tue risposte? I dati vengono salvati automaticamente nel browser, ma √® consigliabile creare un backup manuale.</p>
            <div class="modal-buttons">
                <button class="btn btn-backup" onclick="createBackup(); closeModal()">Crea Backup Ora</button>
                <button class="btn btn-secondary" onclick="closeModal()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Modal Popup Motivazionale -->
    <div id="welcomeModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align: center;">üíô Grazie per prenderti cura della tua sicurezza e di quella dei tuoi colleghi</h3>
            <div class="modal-body">
                <p style="text-align: center; font-size: 1.05rem; line-height: 1.8;">
                    Dedicando qualche minuto a questo questionario, stai contribuendo a rendere il nostro ambiente di lavoro pi√π sicuro per tutti.
                </p>
                <p style="text-align: center; font-size: 1.05rem; line-height: 1.8;">
                    Le tue risposte aiuteranno a identificare dove possiamo migliorare, affinch√© tu e ogni collega possiate tornare a casa sani e salvi ogni giorno.
                </p>
                <p style="text-align: center; font-size: 1.1rem; line-height: 1.8; color: var(--accent); font-weight: 600;">
                    La tua voce conta. La tua famiglia e i tuoi colleghi ti ringraziano.
                </p>
                <p style="text-align: center; font-size: 1.15rem; margin-top: 20px; color: var(--success); font-weight: 700;">
                    üè† Insieme, rendiamo ogni giorno pi√π sicuro.
                </p>
                <div style="margin-top: 25px; padding: 15px; background: rgba(0, 217, 165, 0.1); border-radius: 10px; border: 1px solid var(--success);">
                    <label style="display: flex; align-items: center; cursor: pointer; color: var(--light-gray);">
                        <input type="checkbox" id="dontShowWelcome" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        Non mostrare pi√π questo messaggio oggi
                    </label>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 25px;">
                <button class="btn btn-primary" onclick="closeWelcomeModal()">Inizia Questionario</button>
            </div>
        </div>
    </div>

    <!-- Modal Istruzioni -->
    <div id="helpModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3>üìñ Guida e Istruzioni</h3>
            <div class="modal-body">
                
                <div class="help-section">
                    <h4>üìã Panoramica</h4>
                    <p>Questo questionario valuta il clima di sicurezza nella tua azienda attraverso 6 dimensioni fondamentali.</p>
                    <p><strong>Tempo richiesto:</strong> 10-15 minuti</p>
                    <p><strong>Responsabilit√† personale:</strong> Il tuo nome sar√† associato al questionario perch√© la sicurezza √® un impegno di tutti, e mettendoci la faccia contribuisci attivamente a costruire una cultura della sicurezza.</p>
                </div>

                <div class="help-section">
                    <h4>‚úçÔ∏è Come Compilare</h4>
                    <p><strong>Scala di valutazione (1-5):</strong></p>
                    <ul>
                        <li><strong>1</strong> - Fortemente in disaccordo</li>
                        <li><strong>2</strong> - In disaccordo</li>
                        <li><strong>3</strong> - Neutrale</li>
                        <li><strong>4</strong> - D'accordo</li>
                        <li><strong>5</strong> - Fortemente d'accordo</li>
                    </ul>
                    <p style="margin-top: 10px;"><strong>Consiglio:</strong> Rispondi in modo sincero secondo la tua percezione reale. Non ci sono risposte giuste o sbagliate.</p>
                </div>

                <div class="help-section">
                    <h4>üíæ Esportare e Inviare il Questionario</h4>
                    <p>Dopo aver completato il questionario, devi inviare il file JSON al tuo responsabile.</p>
                    
                    <p style="padding: 10px; background: rgba(0, 191, 219, 0.2); border-radius: 5px; border-left: 3px solid var(--secondary); margin-bottom: 15px;">
                        <strong>üìå Importante:</strong> Il file JSON conterr√† il tuo nome, l'azienda, il periodo di monitoraggio e tutte le tue risposte. 
                        La sicurezza √® responsabilit√† di tutti e il tuo contributo nominativo √® prezioso per migliorare l'ambiente di lavoro.
                    </p>
                    
                    <p style="margin-top: 15px;"><strong class="platform-icon">üì±</strong><strong>DA SMARTPHONE ANDROID:</strong></p>
                    <ol style="margin-left: 20px;">
                        <li>Clicca <strong>"Esporta JSON"</strong></li>
                        <li>Il file viene salvato in <code>Download</code></li>
                        <li><strong>Per trovare il file:</strong>
                            <ul style="margin-left: 15px; margin-top: 5px;">
                                <li>Apri l'app <strong>"File"</strong> o <strong>"I miei file"</strong></li>
                                <li>Vai nella cartella <strong>"Download"</strong></li>
                                <li>Cerca il file: <code>clima_sicurezza_[nome]_[data].json</code></li>
                            </ul>
                        </li>
                        <li><strong>Per inviarlo via email:</strong>
                            <ul style="margin-left: 15px; margin-top: 5px;">
                                <li>Tieni premuto sul file</li>
                                <li>Clicca <strong>"Condividi"</strong></li>
                                <li>Scegli <strong>"Gmail"</strong> o altra app email</li>
                                <li>Il file sar√† gi√† allegato alla email</li>
                            </ul>
                        </li>
                    </ol>

                    <p style="margin-top: 15px;"><strong class="platform-icon">üì±</strong><strong>DA SMARTPHONE iOS (iPhone):</strong></p>
                    <ol style="margin-left: 20px;">
                        <li>Clicca <strong>"Esporta JSON"</strong></li>
                        <li>Apparir√† il popup "Scarica file" - conferma</li>
                        <li><strong>Per trovare il file:</strong>
                            <ul style="margin-left: 15px; margin-top: 5px;">
                                <li>Apri l'app <strong>"File"</strong> (icona cartella blu)</li>
                                <li>Vai in <strong>"Download"</strong> o <strong>"Sul mio iPhone"</strong></li>
                                <li>Cerca il file con la data odierna</li>
                            </ul>
                        </li>
                        <li><strong>Per inviarlo via email:</strong>
                            <ul style="margin-left: 15px; margin-top: 5px;">
                                <li>Tieni premuto sul file</li>
                                <li>Clicca <strong>"Condividi"</strong></li>
                                <li>Scegli <strong>"Mail"</strong></li>
                                <li>Il file sar√† gi√† allegato</li>
                            </ul>
                        </li>
                    </ol>

                    <p style="margin-top: 15px;"><strong class="platform-icon">üíª</strong><strong>DA COMPUTER (Windows/Mac):</strong></p>
                    <ol style="margin-left: 20px;">
                        <li>Clicca <strong>"Esporta JSON"</strong></li>
                        <li>Il file viene salvato nella cartella <code>Download</code></li>
                        <li>Apri il tuo client email</li>
                        <li>Allega il file come faresti con qualsiasi altro documento</li>
                    </ol>

                    <p style="margin-top: 15px; padding: 10px; background: rgba(0, 191, 219, 0.2); border-radius: 5px; border-left: 3px solid var(--secondary);">
                        üí° <strong>Suggerimento:</strong> Su smartphone, dopo aver esportato, usa il pulsante "Condividi" che ti permette di scegliere direttamente l'app email!
                    </p>
                </div>

                <div class="help-section">
                    <h4>üìä Visualizzare Questionari Precedenti</h4>
                    <p>Nella sezione <strong>"Storico Monitoraggi"</strong> in fondo alla pagina puoi:</p>
                    <ul>
                        <li>Cliccare su un questionario passato per visualizzarlo</li>
                        <li>Vedere i risultati e il grafico del periodo</li>
                        <li>Cliccare <strong>"Esci da Visualizzazione"</strong> per tornare alla compilazione</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üíæ Backup dei Dati</h4>
                    <p>Il pulsante <strong>"Backup Dati"</strong> salva:</p>
                    <ul>
                        <li>Tutti i questionari compilati in precedenza</li>
                        <li>Le tue informazioni personali</li>
                        <li>Lo storico completo</li>
                    </ul>
                    <p><strong>Quando fare backup:</strong> Prima di cambiare dispositivo o cancellare i dati del browser</p>
                </div>

                <div class="help-section">
                    <h4>üîí Privacy e Responsabilit√†</h4>
                    <ul>
                        <li>Il questionario √® <strong>nominativo</strong> - il tuo nome √® associato alle tue risposte</li>
                        <li>Questo perch√© la sicurezza richiede <strong>impegno personale e trasparenza</strong></li>
                        <li>I dati sono salvati solo nel tuo browser finch√© non li invii</li>
                        <li>Il file JSON esportato contiene: <strong>nome, azienda, periodo e risposte</strong></li>
                        <li>I risultati aggregati aiutano l'azienda a identificare aree di miglioramento</li>
                        <li>Mettendoci la faccia, dimostri il tuo impegno per la sicurezza di tutti</li>
                    </ul>
                </div>

                <div class="help-section" style="background: rgba(0, 217, 165, 0.1); border-left-color: var(--success);">
                    <h4>‚ùì Hai bisogno di aiuto?</h4>
                    <p>Se hai difficolt√† tecniche o domande sul questionario, contatta il tuo responsabile o il servizio IT aziendale.</p>
                </div>

            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeHelpModal()">Ho Capito</button>
            </div>
        </div>
    </div>

    <script>
        let isViewingHistory = false; // Flag per modalit√† visualizzazione storico
        
        const dimensions = [
            {
                name: "Impegno del Management",
                code: "D1",
                questions: [
                    "Il management considera la sicurezza importante quanto la produzione",
                    "I dirigenti partecipano attivamente alle iniziative di sicurezza",
                    "Vengono allocate risorse adeguate (tempo, budget, personale) per la sicurezza",
                    "Le decisioni del management dimostrano che la sicurezza √® una priorit√†",
                    "Il management ascolta e agisce sulle preoccupazioni di sicurezza dei lavoratori",
                    "I leader aziendali sono visibili e presenti quando si parla di sicurezza"
                ]
            },
            {
                name: "Comunicazione sulla Sicurezza",
                code: "D2",
                questions: [
                    "Le informazioni sulla sicurezza sono comunicate in modo chiaro e tempestivo",
                    "Esistono canali aperti per discutere di problemi di sicurezza",
                    "I lavoratori ricevono feedback quando segnalano situazioni pericolose",
                    "Le riunioni sulla sicurezza sono frequenti e produttive",
                    "Le procedure di sicurezza sono facilmente accessibili e comprensibili",
                    "La comunicazione sulla sicurezza √® bidirezionale (non solo top-down)"
                ]
            },
            {
                name: "Coinvolgimento dei Lavoratori",
                code: "D3",
                questions: [
                    "I lavoratori sono coinvolti nelle decisioni che riguardano la loro sicurezza",
                    "Le opinioni dei lavoratori sulla sicurezza sono valorizzate",
                    "Esiste un comitato/gruppo di lavoro sulla sicurezza con rappresentanti dei lavoratori",
                    "I lavoratori partecipano attivamente alle ispezioni di sicurezza",
                    "Sento di avere voce in capitolo sulle questioni di sicurezza",
                    "I suggerimenti dei lavoratori per migliorare la sicurezza vengono implementati"
                ]
            },
            {
                name: "Formazione e Competenze",
                code: "D4",
                questions: [
                    "Ricevo formazione adeguata per svolgere il mio lavoro in sicurezza",
                    "La formazione sulla sicurezza √® aggiornata regolarmente",
                    "Mi sento competente nel gestire i rischi del mio lavoro",
                    "So come comportarmi in caso di emergenza",
                    "La formazione include esercitazioni pratiche, non solo teoria",
                    "Nuovi dipendenti ricevono formazione completa prima di iniziare a lavorare"
                ]
            },
            {
                name: "Sistema di Segnalazione",
                code: "D5",
                questions: [
                    "Mi sento sicuro nel segnalare problemi di sicurezza senza timore di conseguenze",
                    "Gli incidenti e i near miss vengono analizzati per prevenire recidive",
                    "Ricevo informazioni su cosa √® stato fatto dopo una segnalazione",
                    "Il sistema di segnalazione √® facile da usare",
                    "Le segnalazioni vengono prese sul serio e investigate",
                    "Si impara dagli errori invece di cercare solo colpevoli da punire"
                ]
            },
            {
                name: "Equilibrio Produzione-Sicurezza",
                code: "D6",
                questions: [
                    "Non mi sento mai pressato a scegliere tra produttivit√† e sicurezza",
                    "C'√® tempo sufficiente per svolgere il lavoro in modo sicuro",
                    "La sicurezza non viene sacrificata per rispettare le scadenze",
                    "Non vengo penalizzato se rallento per lavorare in sicurezza",
                    "Le pressioni di produzione non mi portano a saltare procedure di sicurezza",
                    "Il carico di lavoro √® gestibile senza compromettere la sicurezza"
                ]
            }
        ];

        const likertLabels = [
            "Fortemente in disaccordo",
            "In disaccordo",
            "Neutrale",
            "D'accordo",
            "Fortemente d'accordo"
        ];

        // Popola select anno
        function populateYearSelect() {
            const yearSelect = document.getElementById('annoMonitoraggio');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        // Carica dati persistenti
        function loadPersistedData() {
            const persisted = JSON.parse(localStorage.getItem('collaboratoreData') || '{}');
            
            if (persisted.nomeAzienda) document.getElementById('nomeAzienda').value = persisted.nomeAzienda;
            if (persisted.nomePersona) document.getElementById('nomePersona').value = persisted.nomePersona;
            if (persisted.reparto) document.getElementById('reparto').value = persisted.reparto;
            if (persisted.anzianita) document.getElementById('anzianita').value = persisted.anzianita;
        }

        // Salva dati persistenti
        function savePersistedData() {
            const data = {
                nomeAzienda: document.getElementById('nomeAzienda').value,
                nomePersona: document.getElementById('nomePersona').value,
                reparto: document.getElementById('reparto').value,
                anzianita: document.getElementById('anzianita').value
            };
            localStorage.setItem('collaboratoreData', JSON.stringify(data));
        }

        // Aggiungi listener per salvare dati persistenti
        ['nomeAzienda', 'nomePersona', 'reparto', 'anzianita'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', savePersistedData);
                element.addEventListener('blur', savePersistedData);
            }
        });

        function renderQuestionnaire() {
            const container = document.getElementById('questionnaire');
            let html = '';
            let questionId = 0;

            dimensions.forEach((dim, dimIndex) => {
                html += `
                    <div class="dimension-section">
                        <div class="dimension-title">
                            <div class="dimension-number">${dimIndex + 1}</div>
                            ${dim.name}
                        </div>
                `;

                dim.questions.forEach((question, qIndex) => {
                    html += `
                        <div class="question">
                            <div class="question-text">
                                <strong>${dim.code}.${qIndex + 1}</strong> - ${question}
                            </div>
                            <div class="likert-scale">
                    `;

                    for (let i = 1; i <= 5; i++) {
                        html += `
                            <div class="likert-option">
                                <input type="radio" 
                                       id="q${questionId}_${i}" 
                                       name="q${questionId}" 
                                       value="${i}"
                                       onchange="updateProgress()">
                                <label for="q${questionId}_${i}" class="likert-label">
                                    <div style="font-size: 1.2rem; margin-bottom: 5px;">${i}</div>
                                    <div style="font-size: 0.75rem;">${likertLabels[i-1]}</div>
                                </label>
                            </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                    questionId++;
                });

                html += '</div>';
            });

            container.innerHTML = html;
        }

        function updateProgress() {
            const totalQuestions = 36;
            let answeredQuestions = 0;

            for (let i = 0; i < totalQuestions; i++) {
                const radios = document.getElementsByName(`q${i}`);
                for (let radio of radios) {
                    if (radio.checked) {
                        answeredQuestions++;
                        break;
                    }
                }
            }

            const progress = (answeredQuestions / totalQuestions) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function getLevel(score) {
            if (score < 2.5) return { level: 'CRITICO', class: 'critico', color: '#C70039' };
            if (score < 3.0) return { level: 'SCARSO', class: 'scarso', color: '#FF5757' };
            if (score < 3.5) return { level: 'SUFFICIENTE', class: 'sufficiente', color: '#FFB800' };
            if (score < 4.0) return { level: 'BUONO', class: 'buono', color: '#FFE135' };
            if (score < 4.5) return { level: 'MOLTO BUONO', class: 'molto-buono', color: '#92D050' };
            return { level: 'ECCELLENTE', class: 'eccellente', color: '#00D9A5' };
        }

        function validateMetaInfo() {
            const nomeAzienda = document.getElementById('nomeAzienda').value.trim();
            const nomePersona = document.getElementById('nomePersona').value.trim();
            const mese = document.getElementById('meseMonitoraggio').value;
            const anno = document.getElementById('annoMonitoraggio').value;

            if (!nomeAzienda) {
                alert('‚ö†Ô∏è Inserisci il Nome Azienda');
                return false;
            }
            if (!nomePersona) {
                alert('‚ö†Ô∏è Inserisci Nome e Cognome');
                return false;
            }
            if (!mese) {
                alert('‚ö†Ô∏è Seleziona il Mese di Monitoraggio');
                return false;
            }
            if (!anno) {
                alert('‚ö†Ô∏è Seleziona l\'Anno di Monitoraggio');
                return false;
            }
            return true;
        }

        function calculateResults() {
            // Blocca se in modalit√† visualizzazione storico
            if (isViewingHistory) {
                alert('‚ö†Ô∏è Non puoi ricalcolare i risultati in modalit√† visualizzazione storico.\n\nClicca su "Esci da Visualizzazione" per creare un nuovo monitoraggio.');
                return;
            }

            if (!validateMetaInfo()) return;

            const scores = [];
            let questionId = 0;

            // Verifica che tutte le domande abbiano risposta
            for (let i = 0; i < 36; i++) {
                const radios = document.getElementsByName(`q${i}`);
                let answered = false;
                for (let radio of radios) {
                    if (radio.checked) {
                        answered = true;
                        break;
                    }
                }
                if (!answered) {
                    alert('‚ö†Ô∏è Per favore, rispondi a tutte le domande prima di calcolare i risultati.');
                    return;
                }
            }

            dimensions.forEach((dim, dimIndex) => {
                let dimScore = 0;
                dim.questions.forEach((q, qIndex) => {
                    const radios = document.getElementsByName(`q${questionId}`);
                    for (let radio of radios) {
                        if (radio.checked) {
                            dimScore += parseInt(radio.value);
                            break;
                        }
                    }
                    questionId++;
                });
                const avgScore = dimScore / dim.questions.length;
                scores.push({
                    dimension: dim.name,
                    code: dim.code,
                    score: avgScore.toFixed(2)
                });
            });

            displayResults(scores);
            showBackupReminder();
        }

        function displayResults(scores) {
            const resultsSection = document.getElementById('resultsSection');
            const scoresGrid = document.getElementById('scoresGrid');

            // Calcola punteggio complessivo
            const totalScore = scores.reduce((sum, s) => sum + parseFloat(s.score), 0) / scores.length;
            const overallLevel = getLevel(totalScore);

            // Mostra periodo nel grafico
            const mese = document.getElementById('meseMonitoraggio').value;
            const anno = document.getElementById('annoMonitoraggio').value;
            const meseNome = document.getElementById('meseMonitoraggio').options[document.getElementById('meseMonitoraggio').selectedIndex].text;
            document.getElementById('chartPeriod').textContent = `${meseNome} ${anno}`;

            // Mostra card punteggi
            let scoresHTML = `
                <div class="score-card" style="grid-column: 1 / -1; border-left-color: ${overallLevel.color};">
                    <h4>Punteggio Complessivo</h4>
                    <div class="score" style="color: ${overallLevel.color};">${totalScore.toFixed(2)}</div>
                    <span class="level ${overallLevel.class}">${overallLevel.level}</span>
                </div>
            `;

            scores.forEach(s => {
                const level = getLevel(parseFloat(s.score));
                scoresHTML += `
                    <div class="score-card" style="border-left-color: ${level.color};">
                        <h4>${s.code}: ${s.dimension}</h4>
                        <div class="score" style="color: ${level.color};">${s.score}</div>
                        <span class="level ${level.class}">${level.level}</span>
                    </div>
                `;
            });

            scoresGrid.innerHTML = scoresHTML;

            // Crea radar chart
            createRadarChart(scores);

            // Mostra sezione risultati
            resultsSection.classList.add('active');
            
            // Assicurati che i pulsanti siano visibili in modalit√† normale
            const resultButtons = resultsSection.querySelector('.button-group');
            if (resultButtons && !isViewingHistory) {
                resultButtons.style.display = 'flex';
            }
            
            resultsSection.scrollIntoView({ behavior: 'smooth' });

            // Salva nello storico
            saveToHistory(scores, totalScore);
        }

        let radarChartInstance = null;

        function abbreviateDimension(dimension) {
            const isMobile = window.innerWidth < 768;
            if (!isMobile) return dimension;
            
            const abbreviations = {
                "Impegno del Management": "Management",
                "Comunicazione sulla Sicurezza": "Comunicazione",
                "Coinvolgimento dei Lavoratori": "Coinvolgimento",
                "Formazione e Competenze": "Formazione",
                "Sistema di Segnalazione": "Segnalazione",
                "Equilibrio Produzione-Sicurezza": "Equilibrio"
            };
            
            return abbreviations[dimension] || dimension;
        }

        function createRadarChart(scores) {
            const ctx = document.getElementById('radarChart').getContext('2d');

            if (radarChartInstance) {
                radarChartInstance.destroy();
            }

            const isMobile = window.innerWidth < 768;

            const data = {
                labels: scores.map(s => abbreviateDimension(s.dimension)),
                datasets: [{
                    label: 'Punteggio Dimensione',
                    data: scores.map(s => parseFloat(s.score)),
                    backgroundColor: 'rgba(5, 191, 219, 0.2)',
                    borderColor: '#00FFCA',
                    borderWidth: 3,
                    pointBackgroundColor: scores.map(s => getLevel(parseFloat(s.score)).color),
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            };

            const config = {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            min: 0,
                            max: 5,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: isMobile ? 10 : 12,
                                    family: "'IBM Plex Sans', sans-serif"
                                }
                            },
                            pointLabels: {
                                font: {
                                    size: isMobile ? 11 : 13,
                                    weight: '600',
                                    family: "'IBM Plex Sans', sans-serif"
                                },
                                color: '#1A1A2E',
                                padding: isMobile ? 5 : 10
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 46, 0.95)',
                            titleFont: {
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                size: 13
                            },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const score = context.parsed.r;
                                    const level = getLevel(score);
                                    return `Punteggio: ${score.toFixed(2)} - ${level.level}`;
                                }
                            }
                        }
                    }
                }
            };

            radarChartInstance = new Chart(ctx, config);
        }

        async function exportJSON() {
            if (!validateMetaInfo()) return;

            const scores = [];
            let questionId = 0;

            dimensions.forEach((dim, dimIndex) => {
                let dimScore = 0;
                const answers = [];
                dim.questions.forEach((q, qIndex) => {
                    const radios = document.getElementsByName(`q${questionId}`);
                    let value = 0;
                    for (let radio of radios) {
                        if (radio.checked) {
                            value = parseInt(radio.value);
                            dimScore += value;
                            break;
                        }
                    }
                    answers.push({
                        question: q,
                        value: value
                    });
                    questionId++;
                });
                
                const avgScore = dimScore / dim.questions.length;
                scores.push({
                    dimension: dim.name,
                    code: dim.code,
                    score: parseFloat(avgScore.toFixed(2)),
                    level: getLevel(avgScore).level,
                    answers: answers
                });
            });

            const totalScore = scores.reduce((sum, s) => sum + s.score, 0) / scores.length;
            
            const mese = document.getElementById('meseMonitoraggio').value;
            const anno = document.getElementById('annoMonitoraggio').value;
            const meseNome = document.getElementById('meseMonitoraggio').options[document.getElementById('meseMonitoraggio').selectedIndex].text;

            const exportData = {
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('it-IT'),
                nomeAzienda: document.getElementById('nomeAzienda').value,
                nomePersona: document.getElementById('nomePersona').value,
                reparto: document.getElementById('reparto').value || 'Non specificato',
                anzianita: document.getElementById('anzianita').value || 'Non specificato',
                meseMonitoraggio: mese,
                annoMonitoraggio: anno,
                periodoMonitoraggio: `${meseNome} ${anno}`,
                noteAggiuntive: document.getElementById('noteAggiuntive').value || '',
                scores: scores,
                overallScore: parseFloat(totalScore.toFixed(2)),
                overallLevel: getLevel(totalScore).level
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const filename = `clima_sicurezza_${exportData.nomePersona.replace(/\s+/g, '_')}_${anno}_${mese}.json`;

            // Prova Web Share API (moderno, nativo mobile)
            if (navigator.share && navigator.canShare) {
                try {
                    const file = new File([dataBlob], filename, { type: 'application/json' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: 'Questionario Clima di Sicurezza',
                            text: `Questionario compilato da ${exportData.nomePersona} - ${exportData.periodoMonitoraggio}`
                        });
                        alert('‚úÖ File condiviso con successo!');
                        return;
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.log('Web Share non disponibile, uso download classico');
                    } else {
                        return; // Utente ha annullato
                    }
                }
            }

            // Fallback: Download classico
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);

            // Mostra istruzioni per invio email
            showEmailInstructions(filename);
        }

        function showEmailInstructions(filename) {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);

            let instructions = '‚úÖ File scaricato con successo!\n\n';
            
            if (isIOS) {
                instructions += 'üì± ISTRUZIONI iOS:\n\n';
                instructions += '1. Apri l\'app "File"\n';
                instructions += '2. Vai in "Download" o "Sul mio iPhone"\n';
                instructions += '3. Trova il file: ' + filename + '\n';
                instructions += '4. Tieni premuto ‚Üí "Condividi" ‚Üí "Mail"\n';
                instructions += '5. Invia al tuo responsabile\n\n';
                instructions += 'üí° Il file sar√† gi√† allegato alla email!';
            } else if (isAndroid) {
                instructions += 'üì± ISTRUZIONI ANDROID:\n\n';
                instructions += '1. Apri l\'app "File" o "I miei file"\n';
                instructions += '2. Vai in "Download"\n';
                instructions += '3. Trova il file: ' + filename + '\n';
                instructions += '4. Tieni premuto ‚Üí "Condividi" ‚Üí "Gmail"\n';
                instructions += '5. Invia al tuo responsabile\n\n';
                instructions += 'üí° Il file sar√† gi√† allegato alla email!';
            } else {
                instructions += 'üíª Il file √® stato salvato nella cartella Download.\n\n';
                instructions += 'Allegalo a una email e invialo al tuo responsabile.';
            }

            alert(instructions);

            // Opzionale: Apri mailto per facilitare composizione email
            if (isMobile) {
                const subject = encodeURIComponent(`Questionario Clima Sicurezza - ${document.getElementById('nomePersona').value} - ${document.getElementById('meseMonitoraggio').options[document.getElementById('meseMonitoraggio').selectedIndex].text} ${document.getElementById('annoMonitoraggio').value}`);
                const body = encodeURIComponent('In allegato il questionario compilato.\n\n[ALLEGA IL FILE SCARICATO]');
                
                // Apri client email (il file non sar√† allegato automaticamente per limiti di sicurezza)
                setTimeout(() => {
                    window.location.href = `mailto:?subject=${subject}&body=${body}`;
                }, 1000);
            }
        }

        function saveToHistory(scores, totalScore) {
            let history = JSON.parse(localStorage.getItem('safetyClimateHistory') || '[]');
            
            const mese = document.getElementById('meseMonitoraggio').value;
            const anno = document.getElementById('annoMonitoraggio').value;
            const meseNome = document.getElementById('meseMonitoraggio').options[document.getElementById('meseMonitoraggio').selectedIndex].text;

            // Salva tutte le risposte
            let questionId = 0;
            const allAnswers = [];
            dimensions.forEach((dim, dimIndex) => {
                dim.questions.forEach((q, qIndex) => {
                    const radios = document.getElementsByName(`q${questionId}`);
                    let value = 0;
                    for (let radio of radios) {
                        if (radio.checked) {
                            value = parseInt(radio.value);
                            break;
                        }
                    }
                    allAnswers.push({
                        dimensionCode: dim.code,
                        dimensionName: dim.name,
                        question: q,
                        value: value
                    });
                    questionId++;
                });
            });

            history.push({
                date: new Date().toISOString(),
                periodo: `${meseNome} ${anno}`,
                mese: mese,
                anno: anno,
                nomeAzienda: document.getElementById('nomeAzienda').value,
                nomePersona: document.getElementById('nomePersona').value,
                reparto: document.getElementById('reparto').value,
                anzianita: document.getElementById('anzianita').value,
                noteAggiuntive: document.getElementById('noteAggiuntive').value || '',
                scores: scores,
                allAnswers: allAnswers,
                totalScore: totalScore.toFixed(2),
                level: getLevel(totalScore).level
            });

            localStorage.setItem('safetyClimateHistory', JSON.stringify(history));
            displayHistory();
        }

        function displayHistory() {
            const history = JSON.parse(localStorage.getItem('safetyClimateHistory') || '[]');
            
            if (history.length === 0) return;

            const historySection = document.getElementById('historySection');
            const historyList = document.getElementById('historyList');
            
            historySection.style.display = 'block';
            
            let html = '';
            const sortedHistory = [...history].reverse();
            sortedHistory.forEach((item, index) => {
                const level = getLevel(parseFloat(item.totalScore));
                const actualIndex = history.length - 1 - index; // Indice reale nell'array originale
                
                html += `
                    <div class="history-item" onclick="loadHistoryItem(${actualIndex})" title="Clicca per visualizzare questo questionario">
                        <span class="history-date">${item.periodo}</span>
                        <span class="score-value">${item.totalScore}</span>
                        <span class="level ${level.class}">${level.level}</span>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        function loadHistoryItem(index) {
            const history = JSON.parse(localStorage.getItem('safetyClimateHistory') || '[]');
            const item = history[index];
            
            if (!item) {
                alert('Errore nel caricamento del questionario');
                return;
            }

            if (!confirm(`Vuoi visualizzare il questionario di ${item.periodo}?\n\nQuesto √® un questionario storico in modalit√† sola lettura.`)) {
                return;
            }

            // Attiva modalit√† visualizzazione storico
            isViewingHistory = true;

            // Carica i dati del form (incluso mese e anno)
            if (item.nomeAzienda) document.getElementById('nomeAzienda').value = item.nomeAzienda;
            if (item.nomePersona) document.getElementById('nomePersona').value = item.nomePersona;
            if (item.reparto) document.getElementById('reparto').value = item.reparto;
            if (item.anzianita) document.getElementById('anzianita').value = item.anzianita;
            
            // IMPORTANTE: Carica prima mese e anno
            if (item.mese) {
                document.getElementById('meseMonitoraggio').value = item.mese;
            }
            if (item.anno) {
                document.getElementById('annoMonitoraggio').value = item.anno;
            }
            
            if (item.noteAggiuntive) {
                document.getElementById('noteAggiuntive').value = item.noteAggiuntive;
            }

            // Reset tutte le risposte prima di caricare
            for (let i = 0; i < 36; i++) {
                const radios = document.getElementsByName(`q${i}`);
                radios.forEach(radio => radio.checked = false);
            }

            // Carica le risposte
            if (item.allAnswers && Array.isArray(item.allAnswers)) {
                item.allAnswers.forEach((answer, qIndex) => {
                    if (answer.value > 0) {
                        const radio = document.getElementById(`q${qIndex}_${answer.value}`);
                        if (radio) {
                            radio.checked = true;
                        }
                    }
                });
                updateProgress();
            } else if (item.scores && Array.isArray(item.scores)) {
                // Fallback: prova a ricostruire dalle scores (questionari vecchi senza allAnswers)
                let questionId = 0;
                dimensions.forEach((dim, dimIndex) => {
                    const dimScore = item.scores.find(s => s.code === dim.code);
                    if (dimScore && dimScore.answers) {
                        dimScore.answers.forEach((answer, qIndex) => {
                            if (answer.value > 0) {
                                const radio = document.getElementById(`q${questionId}_${answer.value}`);
                                if (radio) {
                                    radio.checked = true;
                                }
                            }
                            questionId++;
                        });
                    } else {
                        questionId += dim.questions.length;
                    }
                });
                updateProgress();
            }

            // Disabilita il pulsante "Calcola Risultati"
            const calcButton = document.querySelector('.btn-primary[onclick="calculateResults()"]');
            if (calcButton) {
                calcButton.disabled = true;
                calcButton.style.opacity = '0.5';
                calcButton.style.cursor = 'not-allowed';
                calcButton.title = 'Calcolo disabilitato in modalit√† visualizzazione storico';
            }

            // Mostra pulsante "Esci da Visualizzazione"
            const exitButton = document.getElementById('exitViewButton');
            if (exitButton) {
                exitButton.style.display = 'inline-block';
            }

            // Nascondi pulsante "Nuovo Monitoraggio" dai risultati (se presente)
            const newMonitoringButton = document.querySelector('.btn-secondary[onclick="newMonitoring()"]');
            if (newMonitoringButton) {
                newMonitoringButton.style.display = 'none';
            }

            // Mostra banner visualizzazione
            showHistoryBanner(item.periodo);

            // Mostra i risultati dello storico se disponibili
            if (item.scores && Array.isArray(item.scores)) {
                displayHistoryResults(item.scores, item.periodo);
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function displayHistoryResults(scores, periodo) {
            const resultsSection = document.getElementById('resultsSection');
            const scoresGrid = document.getElementById('scoresGrid');

            // Calcola punteggio complessivo
            const totalScore = scores.reduce((sum, s) => sum + parseFloat(s.score), 0) / scores.length;
            const overallLevel = getLevel(totalScore);

            // Mostra periodo nel grafico
            document.getElementById('chartPeriod').textContent = periodo;

            // Mostra card punteggi
            let scoresHTML = `
                <div class="score-card" style="grid-column: 1 / -1; border-left-color: ${overallLevel.color};">
                    <h4>Punteggio Complessivo</h4>
                    <div class="score" style="color: ${overallLevel.color};">${totalScore.toFixed(2)}</div>
                    <span class="level ${overallLevel.class}">${overallLevel.level}</span>
                </div>
            `;

            scores.forEach(s => {
                const level = getLevel(parseFloat(s.score));
                scoresHTML += `
                    <div class="score-card" style="border-left-color: ${level.color};">
                        <h4>${s.code}: ${s.dimension}</h4>
                        <div class="score" style="color: ${level.color};">${s.score}</div>
                        <span class="level ${level.class}">${level.level}</span>
                    </div>
                `;
            });

            scoresGrid.innerHTML = scoresHTML;

            // Crea radar chart
            createRadarChart(scores);

            // Mostra sezione risultati
            resultsSection.classList.add('active');
            
            // Nascondi pulsanti Export e Nuovo Monitoraggio dai risultati
            const resultButtons = resultsSection.querySelector('.button-group');
            if (resultButtons) {
                resultButtons.style.display = 'none';
            }
        }

        function exitViewMode() {
            if (confirm('Sei sicuro di voler uscire dalla visualizzazione storico?\n\nSarai riportato alla schermata per creare un nuovo monitoraggio.')) {
                // Disattiva modalit√† visualizzazione storico
                isViewingHistory = false;

                // Rimuovi banner se presente
                const banner = document.getElementById('historyBanner');
                if (banner) {
                    banner.remove();
                }

                // Riabilita pulsante "Calcola Risultati"
                const calcButton = document.querySelector('.btn-primary[onclick="calculateResults()"]');
                if (calcButton) {
                    calcButton.disabled = false;
                    calcButton.style.opacity = '1';
                    calcButton.style.cursor = 'pointer';
                    calcButton.title = '';
                }

                // Nascondi pulsante "Esci da Visualizzazione"
                const exitButton = document.getElementById('exitViewButton');
                if (exitButton) {
                    exitButton.style.display = 'none';
                }

                // Mostra pulsante "Nuovo Monitoraggio" nei risultati
                const newMonitoringButton = document.querySelector('.btn-secondary[onclick="newMonitoring()"]');
                if (newMonitoringButton) {
                    newMonitoringButton.style.display = 'inline-block';
                }

                // Reset solo risposte, non i campi persistenti
                const questionnaire = document.getElementById('questionnaire');
                const radios = questionnaire.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => radio.checked = false);
                
                // Reset note
                document.getElementById('noteAggiuntive').value = '';
                
                // Reset mese e anno al corrente
                const now = new Date();
                document.getElementById('meseMonitoraggio').value = String(now.getMonth() + 1).padStart(2, '0');
                document.getElementById('annoMonitoraggio').value = now.getFullYear();
                
                // Nascondi risultati
                document.getElementById('resultsSection').classList.remove('active');
                
                // Reset progress bar
                document.getElementById('progressFill').style.width = '0%';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function showHistoryBanner(periodo) {
            // Rimuovi banner esistente se presente
            const existingBanner = document.getElementById('historyBanner');
            if (existingBanner) {
                existingBanner.remove();
            }

            // Crea nuovo banner
            const banner = document.createElement('div');
            banner.id = 'historyBanner';
            banner.style.cssText = `
                background: linear-gradient(135deg, #FFB800, #FFC520);
                color: #1A1A2E;
                padding: 15px 20px;
                border-radius: 10px;
                margin-bottom: 20px;
                text-align: center;
                font-weight: 600;
                font-size: 1.1rem;
                box-shadow: 0 5px 15px rgba(255, 184, 0, 0.3);
                animation: fadeIn 0.5s ease;
            `;
            banner.innerHTML = `
                üìñ MODALIT√Ä VISUALIZZAZIONE STORICO - ${periodo}
                <br>
                <span style="font-size: 0.9rem; font-weight: 400;">
                    Questo √® un questionario compilato in precedenza. Clicca su "Esci da Visualizzazione" per creare un nuovo monitoraggio.
                </span>
            `;

            // Inserisci dopo la progress bar
            const progressBar = document.querySelector('.progress-bar');
            progressBar.parentNode.insertBefore(banner, progressBar.nextSibling);
        }

        function newMonitoring() {
            if (confirm('Sei sicuro di voler iniziare un nuovo monitoraggio?\nLe risposte attuali andranno perse, ma i dati personali rimarranno salvati.')) {
                // Reset solo risposte, non i campi persistenti
                const questionnaire = document.getElementById('questionnaire');
                const radios = questionnaire.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => radio.checked = false);
                
                // Reset note
                document.getElementById('noteAggiuntive').value = '';
                
                // Reset mese e anno al corrente
                const now = new Date();
                document.getElementById('meseMonitoraggio').value = String(now.getMonth() + 1).padStart(2, '0');
                document.getElementById('annoMonitoraggio').value = now.getFullYear();
                
                // Nascondi risultati
                document.getElementById('resultsSection').classList.remove('active');
                
                // Mostra i pulsanti dei risultati
                const resultButtons = document.getElementById('resultsSection').querySelector('.button-group');
                if (resultButtons) {
                    resultButtons.style.display = 'flex';
                }
                
                // Reset progress bar
                document.getElementById('progressFill').style.width = '0%';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function createBackup() {
            const allData = {
                persisted: JSON.parse(localStorage.getItem('collaboratoreData') || '{}'),
                history: JSON.parse(localStorage.getItem('safetyClimateHistory') || '[]'),
                backupDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_clima_sicurezza_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Backup creato con successo!');
        }

        function showBackupReminder() {
            // Mostra reminder dopo ogni nuovo questionario completato
            setTimeout(() => {
                document.getElementById('backupModal').classList.add('active');
            }, 1000);
        }

        function closeModal() {
            document.getElementById('backupModal').classList.remove('active');
        }

        function closeWelcomeModal() {
            const dontShow = document.getElementById('dontShowWelcome').checked;
            if (dontShow) {
                const today = new Date().toDateString();
                localStorage.setItem('hideWelcomeUntil', today);
            }
            document.getElementById('welcomeModal').classList.remove('active');
        }

        function showWelcomeModal() {
            const today = new Date().toDateString();
            const hideUntil = localStorage.getItem('hideWelcomeUntil');
            
            // Mostra solo se non √® stato nascosto oggi
            if (hideUntil !== today) {
                setTimeout(() => {
                    document.getElementById('welcomeModal').classList.add('active');
                }, 500);
            }
        }

        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // Inizializza
        populateYearSelect();
        loadPersistedData();
        renderQuestionnaire();
        displayHistory();
        showWelcomeModal(); // Mostra popup motivazionale all'apertura

        // Auto-select mese corrente se non gi√† selezionato
        const now = new Date();
        if (!document.getElementById('meseMonitoraggio').value) {
            document.getElementById('meseMonitoraggio').value = String(now.getMonth() + 1).padStart(2, '0');
        }
    </script>
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrato:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Errore registrazione Service Worker:', error);
                    });
            });
        }

        // Gestione installazione PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostra banner installazione dopo 3 secondi
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('pwaInstallDismissed')) {
                    const installBanner = document.createElement('div');
                    installBanner.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #00FFCA, #05BFDB);
                        color: #1A1A2E;
                        padding: 15px 25px;
                        border-radius: 10px;
                        box-shadow: 0 5px 20px rgba(0, 255, 202, 0.3);
                        z-index: 10000;
                        display: flex;
                        gap: 15px;
                        align-items: center;
                        font-family: 'IBM Plex Sans', sans-serif;
                        font-weight: 600;
                        max-width: 90%;
                    `;
                    installBanner.innerHTML = `
                        <span>üì± Installa M.C.S. sul tuo dispositivo</span>
                        <button onclick="installPWA()" style="background: #1A1A2E; color: #00FFCA; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600;">Installa</button>
                        <button onclick="dismissInstall()" style="background: transparent; color: #1A1A2E; border: none; padding: 8px; cursor: pointer; font-size: 1.2rem;">‚úï</button>
                    `;
                    document.body.appendChild(installBanner);
                    window.installBannerElement = installBanner;
                }
            }, 3000);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ PWA installata');
                    }
                    deferredPrompt = null;
                    if (window.installBannerElement) {
                        window.installBannerElement.remove();
                    }
                });
            }
        }

        function dismissInstall() {
            localStorage.setItem('pwaInstallDismissed', 'true');
            if (window.installBannerElement) {
                window.installBannerElement.remove();
            }
        }
    </script>
</body>
</html>
