<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="M.C.S.R. - Monitoraggio Clima di Sicurezza Responsabile. Dashboard per analisi e report aziendali.">
    <meta name="theme-color" content="#05BFDB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="M.C.S.R.">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <title>M.C.S.R. - Monitoraggio Clima di Sicurezza Responsabile</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #0A4D68;
            --primary-light: #088395;
            --secondary: #05BFDB;
            --accent: #00FFCA;
            --dark: #1A1A2E;
            --gray: #16213E;
            --light-gray: #E8F4F8;
            --white: #FFFFFF;
            --success: #00D9A5;
            --warning: #FFB800;
            --danger: #FF5757;
            --critical: #C70039;
        }
        
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--gray) 100%);
            color: var(--white);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            color: var(--light-gray);
            font-size: 1.1rem;
        }

        .btn-help {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .btn-help:hover {
            background: var(--accent);
            color: var(--dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 202, 0.4);
        }

        .config-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-field label {
            display: block;
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .config-field label.required::after {
            content: ' *';
            color: var(--danger);
        }

        .config-field input,
        .config-field select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--white);
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .config-field input:focus,
        .config-field select:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.15);
        }

        .config-field select option {
            background: var(--dark);
            color: var(--white);
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed var(--secondary);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        .upload-section input[type="file"] {
            display: none;
        }
        
        .upload-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'IBM Plex Sans', sans-serif;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: var(--dark);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 202, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 2px solid var(--secondary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-backup {
            background: var(--warning);
            color: var(--dark);
        }

        .btn-backup:hover {
            background: #FFC520;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 202, 0.15);
        }
        
        .stat-label {
            color: var(--secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
        }
        
        .chart-section h2 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 1.8rem;
            text-align: center;
        }

        .chart-subtitle {
            color: var(--gray);
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .responses-list {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .response-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .response-item:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: translateX(5px);
            border-left-color: var(--accent);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--dark), var(--gray));
            padding: 40px;
            border-radius: 20px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--accent);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-content::-webkit-scrollbar {
            width: 10px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--light-gray);
        }

        .info-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 3px solid var(--accent);
        }

        .dimension-score {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 768px) {
            .config-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .button-group { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Monitoraggio del Clima di Sicurezza</h1>
            <p>Pannello di Controllo Responsabile</p>
            <button class="btn-help" onclick="mostraIstruzioni()">‚ùì Istruzioni</button>
        </div>

        <div class="config-section">
            <h3 style="color: var(--accent); margin-bottom: 20px;">‚öôÔ∏è Configurazione Monitoraggio</h3>
            <div class="config-grid">
                <div class="config-field">
                    <label for="nomeResponsabile" class="required">Nome Responsabile</label>
                    <input type="text" id="nomeResponsabile" placeholder="es. Mario Rossi">
                </div>
                <div class="config-field">
                    <label for="aziendaSelect" class="required">Azienda</label>
                    <select id="aziendaSelect">
                        <option value="">Seleziona azienda...</option>
                    </select>
                </div>
                <div class="config-field">
                    <label for="divisioneSelect" class="required">Divisione</label>
                    <select id="divisioneSelect">
                        <option value="">Seleziona divisione...</option>
                    </select>
                </div>
                <div class="config-field">
                    <label for="meseSelect" class="required">Mese</label>
                    <select id="meseSelect">
                        <option value="">Seleziona mese...</option>
                        <option value="01">Gennaio</option>
                        <option value="02">Febbraio</option>
                        <option value="03">Marzo</option>
                        <option value="04">Aprile</option>
                        <option value="05">Maggio</option>
                        <option value="06">Giugno</option>
                        <option value="07">Luglio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Settembre</option>
                        <option value="10">Ottobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Dicembre</option>
                    </select>
                </div>
                <div class="config-field">
                    <label for="annoSelect" class="required">Anno</label>
                    <select id="annoSelect">
                        <option value="">Seleziona anno...</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="applicaFiltri()">üîç Applica Filtri</button>
                <button class="btn btn-secondary" onclick="gestioneListe()">‚öôÔ∏è Gestisci Aziende e Divisioni</button>
            </div>
        </div>

        <div class="upload-section" onclick="clickUpload()">
            <div class="upload-icon">üì§</div>
            <h3 style="color: var(--accent); margin-bottom: 10px;">Carica Questionari</h3>
            <p style="color: var(--light-gray);">Clicca per selezionare i file JSON</p>
            <p style="color: var(--warning); font-size: 0.9rem; margin-top: 10px;">‚ö†Ô∏è Configura prima e applica i filtri</p>
            <input type="file" id="fileInput" accept=".json" multiple onchange="caricaFile(event)">
        </div>

        <div class="dashboard" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">üìã Questionari</div>
                    <div class="stat-value" id="totalResponses">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚≠ê Punteggio Medio</div>
                    <div class="stat-value" id="averageScore">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìÖ Periodo</div>
                    <div class="stat-value" style="font-size: 1.5rem;" id="periodo">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚ö†Ô∏è Aree Critiche</div>
                    <div class="stat-value" id="criticalAreas">0</div>
                </div>
            </div>

            <div class="chart-section">
                <h2>Radar Clima di Sicurezza Aggregato</h2>
                <div class="chart-subtitle" id="chartSubtitle">-</div>
                <canvas id="radarChart"></canvas>
            </div>

            <div class="responses-list">
                <h3 style="color: var(--accent); margin-bottom: 20px;">üìù Questionari Caricati (Click per visualizzare)</h3>
                <div id="responsesList"></div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="exportDivisionePDF()">üìÑ Report PDF Divisione</button>
                <button class="btn btn-primary" onclick="exportAziendalePDF()">üìä Report PDF Aziendale</button>
                <button class="btn btn-backup" onclick="creaBackup()">üíæ Backup</button>
                <button class="btn btn-danger" onclick="cancellaAll()">üóëÔ∏è Cancella Dati</button>
            </div>
        </div>

        <div class="empty-state" id="emptyState">
            <div style="font-size: 5rem; opacity: 0.5;">üì≠</div>
            <h3 style="color: var(--accent); margin: 20px 0;">Nessun questionario caricato</h3>
            <p>Configura i filtri e carica i file JSON</p>
        </div>
    </div>

    <!-- Modal Visualizzazione Questionario -->
    <div id="viewModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--accent);">üìã Dettaglio Questionario</h2>
                <button class="btn btn-secondary" onclick="chiudiView()" style="padding: 8px 20px;">‚úï Chiudi</button>
            </div>
            <div id="viewContent"></div>
        </div>
    </div>

    <!-- Modal Istruzioni -->
    <div id="helpModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--accent);">üìñ Istruzioni App Responsabile</h2>
                <button class="btn btn-secondary" onclick="chiudiIstruzioni()" style="padding: 8px 20px;">‚úï Chiudi</button>
            </div>
            
            <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üéØ Panoramica</h3>
                    <p>Questa applicazione permette di raccogliere, analizzare e monitorare i questionari sul clima di sicurezza compilati dai collaboratori.</p>
                    <p style="margin-top: 10px;"><strong>Tempo di configurazione iniziale:</strong> 5 minuti</p>
                    <p><strong>Gestione successiva:</strong> 2-3 minuti per caricamento mensile</p>
                </div>

                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üöÄ Primo Utilizzo - Setup Iniziale</h3>
                    <p><strong>IMPORTANTE:</strong> Al primo utilizzo devi configurare le liste.</p>
                    <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                        <li><strong>Inserisci il tuo Nome Responsabile</strong></li>
                        <li><strong>Click su "‚öôÔ∏è Gestisci Aziende e Divisioni"</strong></li>
                        <li><strong>Inserisci "1"</strong> per gestire le aziende</li>
                        <li><strong>Scrivi le aziende</strong> (una per riga):<br>
                            <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; display: block; margin-top: 5px;">
                                Acme S.p.A.<br>
                                Beta Industries Ltd.<br>
                                Gamma Manufacturing
                            </code>
                        </li>
                        <li><strong>Click OK</strong> per salvare</li>
                        <li><strong>Click di nuovo su "‚öôÔ∏è Gestisci..."</strong></li>
                        <li><strong>Inserisci "2"</strong> per gestire le divisioni</li>
                        <li><strong>Seleziona un'azienda</strong> dal dropdown che appare</li>
                        <li><strong>Scrivi le divisioni</strong> per quella azienda (una per riga):<br>
                            <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; display: block; margin-top: 5px;">
                                Produzione<br>
                                Magazzino<br>
                                Amministrazione<br>
                                R&D
                            </code>
                        </li>
                        <li><strong>Ripeti per ogni azienda</strong> (gestisci divisioni per tutte le aziende)</li>
                    </ol>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(0, 191, 219, 0.2); border-radius: 5px; border-left: 3px solid var(--secondary);">
                        <p style="font-size: 0.9rem;">üí° <strong>Suggerimento:</strong> Se hai molte divisioni, fai questo setup con calma. Lo fai UNA VOLTA sola!</p>
                    </div>
                </div>

                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üì• Caricare Questionari - Procedura Mensile</h3>
                    <p><strong>Ogni mese riceverai i file JSON dai collaboratori via email.</strong></p>
                    <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                        <li><strong>Seleziona Azienda</strong> dal dropdown (es: Acme S.p.A.)</li>
                        <li><strong>Seleziona Divisione</strong> (es: Produzione)</li>
                        <li><strong>Seleziona Mese e Anno</strong> (es: Gennaio 2025)</li>
                        <li><strong>Click "üîç Applica Filtri"</strong> - QUESTO PASSO √à OBBLIGATORIO</li>
                        <li><strong>Click sulla sezione "üì§ Carica Questionari"</strong></li>
                        <li><strong>Seleziona tutti i file JSON</strong> ricevuti (puoi selezionarne multipli con Ctrl+Click o Cmd+Click)</li>
                        <li><strong>Attendi il caricamento</strong></li>
                        <li><strong>Vedrai un messaggio</strong>:<br>
                            <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; display: block; margin-top: 5px;">
                                ‚úÖ 5 caricati<br>
                                ‚ö†Ô∏è 3 saltati
                            </code>
                        </li>
                    </ol>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255, 184, 0, 0.2); border-radius: 5px; border-left: 3px solid var(--warning);">
                        <p style="font-size: 0.9rem;">‚ö†Ô∏è <strong>File Saltati:</strong> I file vengono saltati se non corrispondono all'azienda, divisione o periodo selezionato. √à normale!</p>
                    </div>
                </div>

                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üìä Analizzare i Dati</h3>
                    <p><strong>Dopo il caricamento, vedrai automaticamente:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                        <li><strong>4 Card Statistiche:</strong> Numero questionari, punteggio medio, periodo, aree critiche</li>
                        <li><strong>Grafico Radar:</strong> Visualizzazione aggregata di tutte le 6 dimensioni</li>
                        <li><strong>Lista Questionari:</strong> Tutti i questionari caricati</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Per vedere i dettagli di un singolo questionario:</strong></p>
                    <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                        <li><strong>Click sul questionario</strong> nella lista</li>
                        <li><strong>Si apre una finestra</strong> con:
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Nome collaboratore, anzianit√†</li>
                                <li>Punteggio complessivo</li>
                                <li>Punteggi per ogni dimensione</li>
                                <li>Note aggiuntive (se presenti)</li>
                            </ul>
                        </li>
                        <li><strong>Click "Chiudi"</strong> per tornare alla dashboard</li>
                    </ol>
                </div>

                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üìÑ Generare Report PDF</h3>
                    <p><strong>Ci sono DUE tipi di report:</strong></p>
                    
                    <h4 style="color: var(--secondary); margin-top: 15px; margin-bottom: 10px;">1Ô∏è‚É£ Report PDF Divisione</h4>
                    <p>Genera un report dettagliato per la divisione corrente.</p>
                    <p><strong>Contenuto:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 5px; line-height: 1.6;">
                        <li>Azienda, Divisione, Periodo, Responsabile</li>
                        <li>Numero questionari e punteggio medio</li>
                        <li>Grafico radar (immagine)</li>
                        <li>Punteggi dettagliati per ogni dimensione (colorati)</li>
                        <li>Note dei collaboratori</li>
                    </ul>
                    <p style="margin-top: 10px;"><strong>Quando usarlo:</strong> Per presentazioni, riunioni di divisione, archiviazione mensile</p>
                    
                    <h4 style="color: var(--secondary); margin-top: 15px; margin-bottom: 10px;">2Ô∏è‚É£ Report PDF Aziendale</h4>
                    <p>Genera un report comparativo di TUTTE le divisioni dell'azienda per il periodo selezionato.</p>
                    <p><strong>Contenuto:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 5px; line-height: 1.6;">
                        <li>Azienda, Periodo, Responsabile</li>
                        <li>Totale questionari aziendali</li>
                        <li>Analisi per divisione: n. questionari e media (colorata)</li>
                        <li>Comparazione tra divisioni</li>
                    </ul>
                    <p style="margin-top: 10px;"><strong>Quando usarlo:</strong> Per riunioni direttive, confronti tra divisioni, report strategici</p>
                    
                    <div style="margin-top: 15px; padding: 10px; background: rgba(0, 191, 219, 0.2); border-radius: 5px; border-left: 3px solid var(--secondary);">
                        <p style="font-size: 0.9rem;">üí° <strong>Colori nei PDF:</strong> I punteggi sono colorati (rosso=critico, giallo=sufficiente, verde=ottimo) per identificare rapidamente le priorit√†.</p>
                    </div>
                </div>

                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üîÑ Cambiare Periodo o Divisione</h3>
                    <p><strong>Per analizzare altri dati:</strong></p>
                    <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                        <li><strong>Cambia Azienda/Divisione/Mese/Anno</strong> nei dropdown</li>
                        <li><strong>Click "Applica Filtri"</strong></li>
                        <li><strong>La dashboard si aggiorna</strong> con i dati del nuovo periodo/divisione</li>
                    </ol>
                    <p style="margin-top: 10px;"><strong>Tutti i dati precedenti rimangono salvati!</strong> Puoi navigare tra periodi diversi liberamente.</p>
                </div>

                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üíæ Backup e Sicurezza</h3>
                    <p><strong>Click su "üíæ Backup"</strong> per salvare tutto:</p>
                    <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                        <li>Tutti i questionari caricati</li>
                        <li>Tutte le configurazioni (aziende, divisioni)</li>
                        <li>Storico completo multi-periodo</li>
                    </ul>
                    <p style="margin-top: 10px;"><strong>File generato:</strong> <code style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 3px;">Backup_2025-01-20.json</code></p>
                    <p style="margin-top: 10px;"><strong>Consiglio:</strong> Crea un backup mensile dopo aver caricato tutti i questionari.</p>
                    
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255, 87, 87, 0.2); border-radius: 5px; border-left: 3px solid var(--danger);">
                        <p style="font-size: 0.9rem;">‚ö†Ô∏è <strong>Attenzione:</strong> Il pulsante "üóëÔ∏è Cancella Dati" elimina TUTTO in modo permanente. Usa solo se necessario!</p>
                    </div>
                </div>

                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üí° Suggerimenti e Best Practices</h3>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>Crea una cartella email</strong> "Questionari Clima Sicurezza" per raccogliere i file JSON</li>
                        <li><strong>Carica i questionari mensilmente</strong> subito dopo la scadenza</li>
                        <li><strong>Genera i PDF subito dopo il caricamento</strong> per archiviare o condividere</li>
                        <li><strong>Usa il Report Divisione</strong> per analisi dettagliate</li>
                        <li><strong>Usa il Report Aziendale</strong> per confronti strategici</li>
                        <li><strong>Backup mensile</strong> per sicurezza</li>
                        <li><strong>I dati rimangono nel browser</strong> - non cancellare i dati del browser!</li>
                    </ul>
                </div>

                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">‚ùì Domande Frequenti</h3>
                    
                    <p style="margin-top: 15px;"><strong>Q: Posso caricare file di mesi/anni diversi contemporaneamente?</strong></p>
                    <p>A: S√¨! I file vengono automaticamente organizzati per azienda-divisione-periodo. Ogni combinazione ha il suo "cassetto" separato.</p>
                    
                    <p style="margin-top: 15px;"><strong>Q: Cosa succede se carico lo stesso file due volte?</strong></p>
                    <p>A: Il questionario verr√† duplicato. Fai attenzione a non ricaricare file gi√† importati.</p>
                    
                    <p style="margin-top: 15px;"><strong>Q: Posso modificare aziende/divisioni dopo averle create?</strong></p>
                    <p>A: S√¨, usa sempre "‚öôÔ∏è Gestisci Aziende e Divisioni" per modificare le liste.</p>
                    
                    <p style="margin-top: 15px;"><strong>Q: I PDF includono tutti i dettagli?</strong></p>
                    <p>A: S√¨, includono statistiche, grafico radar, punteggi per dimensione e note dei collaboratori.</p>
                    
                    <p style="margin-top: 15px;"><strong>Q: Posso usare l'app su pi√π computer?</strong></p>
                    <p>A: I dati sono salvati localmente nel browser. Usa il Backup per trasferire i dati tra computer.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === VARIABILI GLOBALI ===
        let storage = {};
        let config = { responsabile: '', azienda: '', divisione: '', mese: '', anno: '' };
        let aziende = [];
        let divisioni = {};
        let responses = [];
        let chart = null;

        // === INIZIALIZZAZIONE ===
        function init() {
            caricaConfig();
            caricaStorage();
            popolaAnni();
            impostaDataCorrente();
            aggiornaSelects();
        }

        function caricaConfig() {
            const saved = localStorage.getItem('managerConfig');
            if (saved) {
                config = JSON.parse(saved);
                if (config.responsabile) document.getElementById('nomeResponsabile').value = config.responsabile;
            }
            
            const savedAziende = localStorage.getItem('aziende');
            if (savedAziende) aziende = JSON.parse(savedAziende);
            
            const savedDivisioni = localStorage.getItem('divisioni');
            if (savedDivisioni) divisioni = JSON.parse(savedDivisioni);
        }

        function salvaConfig() {
            config.responsabile = document.getElementById('nomeResponsabile').value;
            config.azienda = document.getElementById('aziendaSelect').value;
            config.divisione = document.getElementById('divisioneSelect').value;
            config.mese = document.getElementById('meseSelect').value;
            config.anno = document.getElementById('annoSelect').value;
            localStorage.setItem('managerConfig', JSON.stringify(config));
        }

        function caricaStorage() {
            const saved = localStorage.getItem('responsabileStorage');
            if (saved) storage = JSON.parse(saved);
        }

        function salvaStorage() {
            localStorage.setItem('responsabileStorage', JSON.stringify(storage));
        }

        function popolaAnni() {
            const select = document.getElementById('annoSelect');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            }
        }

        function impostaDataCorrente() {
            const now = new Date();
            document.getElementById('meseSelect').value = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('annoSelect').value = now.getFullYear();
        }

        function aggiornaSelects() {
            // Popola aziende
            const azSelect = document.getElementById('aziendaSelect');
            azSelect.innerHTML = '<option value="">Seleziona azienda...</option>';
            aziende.forEach(az => {
                const opt = document.createElement('option');
                opt.value = az;
                opt.textContent = az;
                azSelect.appendChild(opt);
            });
            if (config.azienda) azSelect.value = config.azienda;
            
            // Popola divisioni
            aggiornaDivisioni();
        }

        function aggiornaDivisioni() {
            const azienda = document.getElementById('aziendaSelect').value;
            const divSelect = document.getElementById('divisioneSelect');
            divSelect.innerHTML = '<option value="">Seleziona divisione...</option>';
            
            if (azienda && divisioni[azienda]) {
                divisioni[azienda].forEach(div => {
                    const opt = document.createElement('option');
                    opt.value = div;
                    opt.textContent = div;
                    divSelect.appendChild(opt);
                });
            }
            if (config.divisione) divSelect.value = config.divisione;
        }

        document.getElementById('aziendaSelect').addEventListener('change', aggiornaDivisioni);

        // === GESTIONE LISTE ===
        function gestioneListe() {
            const choice = prompt('Gestisci:\n\n1 - Aziende\n2 - Divisioni\n\nInserisci 1 o 2:');
            if (choice === '1') {
                gestioneAziende();
            } else if (choice === '2') {
                gestioneDivisioni();
            }
        }

        function gestioneAziende() {
            const current = aziende.join('\n');
            const newList = prompt('=== GESTISCI AZIENDE ===\n\nUna per riga:\n\n', current);
            if (newList !== null) {
                aziende = newList.split('\n').map(a => a.trim()).filter(a => a);
                localStorage.setItem('aziende', JSON.stringify(aziende));
                aggiornaSelects();
                alert('‚úÖ Aziende aggiornate!');
            }
        }

        function gestioneDivisioni() {
            const azienda = document.getElementById('aziendaSelect').value;
            if (!azienda) {
                alert('‚ö†Ô∏è Seleziona prima un\'azienda');
                return;
            }
            const current = divisioni[azienda] ? divisioni[azienda].join('\n') : '';
            const newList = prompt(`=== DIVISIONI PER ${azienda.toUpperCase()} ===\n\nUna per riga:\n\n`, current);
            if (newList !== null) {
                divisioni[azienda] = newList.split('\n').map(d => d.trim()).filter(d => d);
                localStorage.setItem('divisioni', JSON.stringify(divisioni));
                aggiornaDivisioni();
                alert('‚úÖ Divisioni aggiornate!');
            }
        }

        // === APPLICAZIONE FILTRI ===
        function applicaFiltri() {
            const resp = document.getElementById('nomeResponsabile').value.trim();
            const az = document.getElementById('aziendaSelect').value;
            const div = document.getElementById('divisioneSelect').value;
            const mese = document.getElementById('meseSelect').value;
            const anno = document.getElementById('annoSelect').value;
            
            if (!resp || !az || !div || !mese || !anno) {
                alert('‚ö†Ô∏è Compila tutti i campi');
                return;
            }
            
            salvaConfig();
            caricaResponses();
            alert('‚úÖ Filtri applicati!');
        }

        function caricaResponses() {
            const key = `${config.azienda}|${config.divisione}|${config.anno}-${config.mese}`;
            responses = storage[key] || [];
            aggiornaDashboard();
        }

        // === CARICAMENTO FILE ===
        function clickUpload() {
            if (!config.azienda || !config.divisione) {
                alert('‚ö†Ô∏è Applica prima i filtri!');
                return;
            }
            document.getElementById('fileInput').click();
        }

        function caricaFile(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            let loaded = 0;
            let skipped = 0;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Auto-add azienda/divisione
                        if (data.nomeAzienda && !aziende.includes(data.nomeAzienda)) {
                            aziende.push(data.nomeAzienda);
                            localStorage.setItem('aziende', JSON.stringify(aziende));
                        }
                        if (data.nomeAzienda && data.reparto) {
                            if (!divisioni[data.nomeAzienda]) divisioni[data.nomeAzienda] = [];
                            if (!divisioni[data.nomeAzienda].includes(data.reparto)) {
                                divisioni[data.nomeAzienda].push(data.reparto);
                                localStorage.setItem('divisioni', JSON.stringify(divisioni));
                            }
                        }
                        
                        // Filtra
                        if (data.nomeAzienda === config.azienda && 
                            data.reparto === config.divisione &&
                            data.meseMonitoraggio === config.mese &&
                            data.annoMonitoraggio == config.anno) {
                            
                            const key = `${config.azienda}|${config.divisione}|${config.anno}-${config.mese}`;
                            if (!storage[key]) storage[key] = [];
                            storage[key].push(data);
                            loaded++;
                        } else {
                            skipped++;
                        }
                    } catch(err) {
                        console.error('Errore file:', err);
                    }
                    
                    if (loaded + skipped === files.length) {
                        salvaStorage();
                        aggiornaSelects();
                        caricaResponses();
                        
                        let message = `‚úÖ ${loaded} caricati`;
                        if (skipped > 0) message += `\n‚ö†Ô∏è ${skipped} saltati`;
                        alert(message);
                        
                        // Mostra reminder backup se ha caricato file
                        if (loaded > 0) {
                            setTimeout(() => {
                                if (confirm('üíæ PROMEMORIA BACKUP\n\nHai appena caricato nuovi questionari.\n\nVuoi creare un backup ora per sicurezza?')) {
                                    creaBackup();
                                }
                            }, 1000);
                        }
                        
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            });
        }

        // === DASHBOARD ===
        function aggiornaDashboard() {
            if (responses.length === 0) {
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('emptyState').style.display = 'none';
            
            const avg = responses.reduce((sum, r) => sum + r.overallScore, 0) / responses.length;
            const mesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
            const periodo = `${mesi[parseInt(config.mese)-1]} ${config.anno}`;
            
            document.getElementById('totalResponses').textContent = responses.length;
            document.getElementById('averageScore').textContent = avg.toFixed(2);
            document.getElementById('periodo').textContent = periodo;
            document.getElementById('chartSubtitle').textContent = `${config.azienda} - ${config.divisione} - ${periodo}`;
            
            // Calcola medie dimensioni
            const dims = {};
            responses.forEach(r => {
                r.scores.forEach(s => {
                    if (!dims[s.dimension]) dims[s.dimension] = { total: 0, count: 0, code: s.code };
                    dims[s.dimension].total += s.score;
                    dims[s.dimension].count++;
                });
            });
            
            const scores = Object.keys(dims).map(d => ({
                dimension: d,
                code: dims[d].code,
                score: dims[d].total / dims[d].count
            })).sort((a,b) => a.code.localeCompare(b.code));
            
            document.getElementById('criticalAreas').textContent = scores.filter(s => s.score < 3.0).length;
            
            creaRadar(scores);
            mostraLista();
        }

        function creaRadar(scores) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: scores.map(s => s.dimension),
                    datasets: [{
                        label: 'Punteggio',
                        data: scores.map(s => s.score),
                        backgroundColor: 'rgba(5, 191, 219, 0.2)',
                        borderColor: '#00FFCA',
                        borderWidth: 3,
                        pointBackgroundColor: scores.map(s => getColor(s.score)),
                        pointBorderColor: '#fff',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            min: 0,
                            max: 5,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function getColor(score) {
            if (score < 2.5) return '#C70039';
            if (score < 3.0) return '#FF5757';
            if (score < 3.5) return '#FFB800';
            if (score < 4.0) return '#FFE135';
            if (score < 4.5) return '#92D050';
            return '#00D9A5';
        }

        function mostraLista() {
            const list = document.getElementById('responsesList');
            list.innerHTML = '';
            
            responses.forEach((r, i) => {
                const div = document.createElement('div');
                div.className = 'response-item';
                div.onclick = function() { visualizzaQuestionario(i); };
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: var(--secondary); font-family: 'JetBrains Mono', monospace;">${r.periodoMonitoraggio || r.date}</div>
                            <div style="margin-top: 5px;"><strong>${r.nomePersona}</strong> - ${r.reparto}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-family: 'JetBrains Mono', monospace; color: ${getColor(r.overallScore)};">${r.overallScore}</div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // === VISUALIZZAZIONE QUESTIONARIO ===
        function visualizzaQuestionario(index) {
            const r = responses[index];
            let html = `
                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">Informazioni Generali</h3>
                    <p><strong>Nome:</strong> ${r.nomePersona}</p>
                    <p><strong>Azienda:</strong> ${r.nomeAzienda}</p>
                    <p><strong>Divisione:</strong> ${r.reparto}</p>
                    <p><strong>Periodo:</strong> ${r.periodoMonitoraggio || r.date}</p>
                    <p><strong>Anzianit√†:</strong> ${r.anzianita} anni</p>
                    <p style="margin-top: 15px;"><strong>Punteggio Complessivo:</strong> <span style="color: ${getColor(r.overallScore)}; font-size: 1.8rem; font-weight: bold;">${r.overallScore}</span></p>
                </div>
                
                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">Punteggi per Dimensione</h3>
            `;
            
            r.scores.forEach(s => {
                html += `
                    <div class="dimension-score" style="border-left: 4px solid ${getColor(s.score)};">
                        <span><strong>${s.code}:</strong> ${s.dimension}</span>
                        <span style="color: ${getColor(s.score)}; font-weight: bold; font-size: 1.2rem;">${s.score}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // === SEZIONE RISPOSTE DETTAGLIATE ===
            html += `
                <div class="info-box">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üìù Risposte Dettagliate alle Domande</h3>
            `;
            
            // Per ogni dimensione, mostra le risposte dettagliate
            r.scores.forEach((dimScore, dimIndex) => {
                html += `
                    <div style="margin-top: 25px; margin-bottom: 25px;">
                        <h4 style="color: var(--secondary); margin-bottom: 15px; font-size: 1.1rem;">
                            ${dimScore.code}: ${dimScore.dimension} 
                            <span style="color: ${getColor(dimScore.score)}; font-weight: bold;">(Media: ${dimScore.score})</span>
                        </h4>
                `;
                
                // Mostra ogni domanda con la sua risposta
                if (dimScore.answers && dimScore.answers.length > 0) {
                    dimScore.answers.forEach((answer, idx) => {
                        const risposta = answer.value;
                        const domanda = answer.question;
                        const stars = getStars(risposta);
                        const colore = getColor(risposta);
                        
                        html += `
                            <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 5px; border-left: 4px solid ${colore};">
                                <div style="flex: 1; padding-right: 15px;">
                                    <strong style="color: var(--light-gray);">${dimScore.code}.${idx + 1}:</strong> ${domanda}
                                </div>
                                <div style="min-width: 150px; text-align: right; white-space: nowrap;">
                                    <span style="color: ${colore}; font-weight: bold; font-size: 1.1rem;">${risposta}</span>
                                    <span style="margin-left: 8px; font-size: 0.9rem;">${stars}</span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: var(--light-gray); font-style: italic;">Dettagli domande non disponibili per questo questionario</p>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            
            if (r.noteAggiuntive && r.noteAggiuntive.trim()) {
                html += `
                    <div class="info-box">
                        <h3 style="color: var(--accent); margin-bottom: 15px;">üìù Note Aggiuntive</h3>
                        <p style="white-space: pre-wrap; color: var(--light-gray);">${r.noteAggiuntive}</p>
                    </div>
                `;
            }
            
            document.getElementById('viewContent').innerHTML = html;
            document.getElementById('viewModal').classList.add('active');
        }

        function getStars(score) {
            const filled = '‚≠ê';
            const empty = '‚òÜ';
            return filled.repeat(score) + empty.repeat(5 - score);
        }

        function chiudiView() {
            document.getElementById('viewModal').classList.remove('active');
        }

        function mostraIstruzioni() {
            document.getElementById('helpModal').classList.add('active');
        }

        function chiudiIstruzioni() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // === EXPORT PDF ===
        async function exportDivisionePDF() {
            if (responses.length === 0) {
                alert('Nessun dato');
                return;
            }
            
            try {
                // Cattura il grafico come immagine
                const canvas = document.getElementById('radarChart');
                const chartImage = await html2canvas(canvas, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                const chartDataUrl = chartImage.toDataURL('image/png');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                let y = 20;
                
                // Header
                pdf.setFillColor(5, 191, 219);
                pdf.rect(0, 0, 210, 35, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(18);
                pdf.setFont(undefined, 'bold');
                pdf.text('REPORT CLIMA DI SICUREZZA - DIVISIONE', 105, 15, { align: 'center' });
                
                y = 45;
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text(`Azienda: ${config.azienda}`, 20, y);
                y += 6;
                pdf.text(`Divisione: ${config.divisione}`, 20, y);
                y += 6;
                const mesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
                pdf.text(`Periodo: ${mesi[parseInt(config.mese)-1]} ${config.anno}`, 20, y);
                y += 6;
                pdf.text(`Responsabile: ${config.responsabile}`, 20, y);
                y += 6;
                pdf.setFont(undefined, 'normal');
                pdf.text(`Questionari ricevuti: ${responses.length}`, 20, y);
                
                const avg = responses.reduce((sum, r) => sum + r.overallScore, 0) / responses.length;
                y += 6;
                const col = getColorRGB(avg);
                pdf.setTextColor(col.r, col.g, col.b);
                pdf.setFont(undefined, 'bold');
                pdf.text(`Punteggio medio: ${avg.toFixed(2)}`, 20, y);
                pdf.setTextColor(0, 0, 0);
                
                // Aggiungi grafico radar
                y += 15;
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.text('GRAFICO RADAR AGGREGATO:', 20, y);
                y += 10;
                
                // Inserisci l'immagine del grafico
                const imgWidth = 170;
                const imgHeight = (chartImage.height * imgWidth) / chartImage.width;
                pdf.addImage(chartDataUrl, 'PNG', 20, y, imgWidth, imgHeight);
                y += imgHeight + 10;
                
                // Se lo spazio non basta, vai a pagina nuova
                if (y > 200) {
                    pdf.addPage();
                    y = 20;
                }
                
                // Calcola medie dimensioni
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.text('PUNTEGGI PER DIMENSIONE:', 20, y);
                y += 8;
                
                const dims = {};
                responses.forEach(r => {
                    r.scores.forEach(s => {
                        if (!dims[s.dimension]) dims[s.dimension] = { total: 0, count: 0, code: s.code };
                        dims[s.dimension].total += s.score;
                        dims[s.dimension].count++;
                    });
                });
                
                const scores = Object.keys(dims).map(d => ({
                    dimension: d,
                    code: dims[d].code,
                    score: dims[d].total / dims[d].count
                })).sort((a,b) => a.code.localeCompare(b.code));
                
                pdf.setFontSize(10);
                scores.forEach(s => {
                    if (y > 270) {
                        pdf.addPage();
                        y = 20;
                    }
                    const col = getColorRGB(s.score);
                    pdf.setFont(undefined, 'normal');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`${s.code}: ${s.dimension}`, 25, y);
                    pdf.setTextColor(col.r, col.g, col.b);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`${s.score.toFixed(2)}`, 160, y);
                    y += 6;
                });
                
                // Note
                const withNotes = responses.filter(r => r.noteAggiuntive && r.noteAggiuntive.trim());
                if (withNotes.length > 0) {
                    y += 10;
                    if (y > 250) {
                        pdf.addPage();
                        y = 20;
                    }
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(13);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('NOTE COLLABORATORI:', 20, y);
                    y += 8;
                    
                    withNotes.forEach(r => {
                        if (y > 260) {
                            pdf.addPage();
                            y = 20;
                        }
                        pdf.setFontSize(10);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(`${r.nomePersona}:`, 25, y);
                        y += 5;
                        pdf.setFont(undefined, 'normal');
                        const lines = pdf.splitTextToSize(r.noteAggiuntive, 160);
                        pdf.text(lines, 25, y);
                        y += (lines.length * 5) + 5;
                    });
                }
                
                pdf.save(`Report_${config.azienda}_${config.divisione}_${config.anno}_${config.mese}.pdf`);
                alert('‚úÖ PDF creato!');
            } catch (error) {
                console.error('Errore generazione PDF:', error);
                alert('‚ùå Errore nella generazione del PDF: ' + error.message);
            }
        }

        async function exportAziendalePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Raccogli tutte le divisioni
            const periodo = `${config.anno}-${config.mese}`;
            const divs = {};
            let allResponses = [];
            
            Object.keys(storage).forEach(key => {
                const [az, div, per] = key.split('|');
                if (az === config.azienda && per === periodo && storage[key].length > 0) {
                    divs[div] = storage[key];
                    allResponses = allResponses.concat(storage[key]);
                }
            });
            
            if (Object.keys(divs).length === 0) {
                alert('Nessun dato per report aziendale');
                return;
            }
            
            try {
                // Calcola punteggi aggregati di TUTTE le risposte aziendali
                const dims = {};
                allResponses.forEach(r => {
                    r.scores.forEach(s => {
                        if (!dims[s.dimension]) dims[s.dimension] = { total: 0, count: 0, code: s.code };
                        dims[s.dimension].total += s.score;
                        dims[s.dimension].count++;
                    });
                });
                
                const aggregateScores = Object.keys(dims).map(d => ({
                    dimension: d,
                    code: dims[d].code,
                    score: dims[d].total / dims[d].count
                })).sort((a,b) => a.code.localeCompare(b.code));
                
                // Crea un canvas temporaneo per il grafico aggregato aziendale
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 800;
                tempCanvas.height = 600;
                const tempCtx = tempCanvas.getContext('2d');
                
                const tempChart = new Chart(tempCtx, {
                    type: 'radar',
                    data: {
                        labels: aggregateScores.map(s => s.dimension),
                        datasets: [{
                            label: 'Punteggio Aziendale Aggregato',
                            data: aggregateScores.map(s => s.score),
                            backgroundColor: 'rgba(5, 191, 219, 0.2)',
                            borderColor: '#00FFCA',
                            borderWidth: 3,
                            pointBackgroundColor: aggregateScores.map(s => getColor(s.score)),
                            pointBorderColor: '#fff',
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: false,
                        scales: {
                            r: {
                                min: 0,
                                max: 5,
                                ticks: { stepSize: 1 }
                            }
                        },
                        plugins: { 
                            legend: { display: false },
                            title: {
                                display: true,
                                text: `${config.azienda} - Aggregato Aziendale`,
                                font: { size: 16 }
                            }
                        }
                    }
                });
                
                // Aspetta che il grafico sia renderizzato
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Converti in immagine
                const chartDataUrl = tempCanvas.toDataURL('image/png');
                
                // Distruggi il grafico temporaneo
                tempChart.destroy();
                
                let y = 20;
                pdf.setFillColor(5, 191, 219);
                pdf.rect(0, 0, 210, 35, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(18);
                pdf.setFont(undefined, 'bold');
                pdf.text('REPORT AZIENDALE CLIMA DI SICUREZZA', 105, 15, { align: 'center' });
                
                y = 45;
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text(`Azienda: ${config.azienda}`, 20, y);
                y += 6;
                const mesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
                pdf.text(`Periodo: ${mesi[parseInt(config.mese)-1]} ${config.anno}`, 20, y);
                y += 6;
                pdf.text(`Responsabile: ${config.responsabile}`, 20, y);
                
                let totalQ = 0;
                Object.values(divs).forEach(d => totalQ += d.length);
                y += 6;
                pdf.setFont(undefined, 'normal');
                pdf.text(`Totale questionari: ${totalQ}`, 20, y);
                
                const avgAziendale = allResponses.reduce((sum, r) => sum + r.overallScore, 0) / allResponses.length;
                y += 6;
                const col = getColorRGB(avgAziendale);
                pdf.setTextColor(col.r, col.g, col.b);
                pdf.setFont(undefined, 'bold');
                pdf.text(`Media aziendale: ${avgAziendale.toFixed(2)}`, 20, y);
                pdf.setTextColor(0, 0, 0);
                
                // Aggiungi grafico radar aggregato aziendale
                y += 15;
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.text('GRAFICO RADAR AGGREGATO AZIENDALE:', 20, y);
                y += 10;
                
                const imgWidth = 170;
                const imgHeight = (tempCanvas.height * imgWidth) / tempCanvas.width;
                pdf.addImage(chartDataUrl, 'PNG', 20, y, imgWidth, imgHeight);
                y += imgHeight + 10;
                
                // Nuova pagina per analisi divisioni
                pdf.addPage();
                y = 20;
                
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.text('ANALISI PER DIVISIONE:', 20, y);
                y += 10;
                
                pdf.setFontSize(10);
                Object.keys(divs).forEach(div => {
                    if (y > 260) {
                        pdf.addPage();
                        y = 20;
                    }
                    const resps = divs[div];
                    const avg = resps.reduce((sum, r) => sum + r.overallScore, 0) / resps.length;
                    const col = getColorRGB(avg);
                    
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`${div}:`, 25, y);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(`${resps.length} questionari`, 80, y);
                    pdf.setTextColor(col.r, col.g, col.b);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Media: ${avg.toFixed(2)}`, 140, y);
                    y += 7;
                });
                
                // Aggiungi punteggi per dimensione aggregati
                y += 10;
                if (y > 220) {
                    pdf.addPage();
                    y = 20;
                }
                
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.text('PUNTEGGI AGGREGATI PER DIMENSIONE:', 20, y);
                y += 8;
                
                pdf.setFontSize(10);
                aggregateScores.forEach(s => {
                    if (y > 270) {
                        pdf.addPage();
                        y = 20;
                    }
                    const col = getColorRGB(s.score);
                    pdf.setFont(undefined, 'normal');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`${s.code}: ${s.dimension}`, 25, y);
                    pdf.setTextColor(col.r, col.g, col.b);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`${s.score.toFixed(2)}`, 160, y);
                    y += 6;
                });
                
                pdf.save(`Report_Aziendale_${config.azienda}_${config.anno}_${config.mese}.pdf`);
                alert('‚úÖ PDF aziendale creato!');
            } catch (error) {
                console.error('Errore generazione PDF aziendale:', error);
                alert('‚ùå Errore nella generazione del PDF: ' + error.message);
            }
        }

        function getColorRGB(score) {
            if (score < 2.5) return { r: 199, g: 0, b: 57 };
            if (score < 3.0) return { r: 255, g: 87, b: 87 };
            if (score < 3.5) return { r: 255, g: 184, b: 0 };
            if (score < 4.0) return { r: 255, g: 225, b: 53 };
            if (score < 4.5) return { r: 146, g: 208, b: 80 };
            return { r: 0, g: 217, b: 165 };
        }

        // === BACKUP E CANCELLA ===
        function creaBackup() {
            const backup = {
                date: new Date().toISOString(),
                storage: storage,
                config: config,
                aziende: aziende,
                divisioni: divisioni
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('‚úÖ Backup creato!');
        }

        function cancellaAll() {
            if (confirm('‚ö†Ô∏è Cancellare TUTTI i dati?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // === AVVIO ===
        init();
    </script>
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrato:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Errore registrazione Service Worker:', error);
                    });
            });
        }

        // Gestione installazione PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostra banner installazione dopo 3 secondi
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('pwaInstallDismissed')) {
                    const installBanner = document.createElement('div');
                    installBanner.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #05BFDB, #00FFCA);
                        color: #1A1A2E;
                        padding: 15px 25px;
                        border-radius: 10px;
                        box-shadow: 0 5px 20px rgba(5, 191, 219, 0.3);
                        z-index: 10000;
                        display: flex;
                        gap: 15px;
                        align-items: center;
                        font-family: 'IBM Plex Sans', sans-serif;
                        font-weight: 600;
                        max-width: 90%;
                    `;
                    installBanner.innerHTML = `
                        <span>üìä Installa M.C.S.R. sul tuo dispositivo</span>
                        <button onclick="installPWA()" style="background: #1A1A2E; color: #05BFDB; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600;">Installa</button>
                        <button onclick="dismissInstall()" style="background: transparent; color: #1A1A2E; border: none; padding: 8px; cursor: pointer; font-size: 1.2rem;">‚úï</button>
                    `;
                    document.body.appendChild(installBanner);
                    window.installBannerElement = installBanner;
                }
            }, 3000);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ PWA installata');
                    }
                    deferredPrompt = null;
                    if (window.installBannerElement) {
                        window.installBannerElement.remove();
                    }
                });
            }
        }

        function dismissInstall() {
            localStorage.setItem('pwaInstallDismissed', 'true');
            if (window.installBannerElement) {
                window.installBannerElement.remove();
            }
        }
    </script>
</body>
</html>
